# 🚀 V4 Feature Backlog: The Relay Supervision Protocol

## 📌 Context
目前的 V3 (Bionic) 逻辑是“管家叫醒 -> 任务结束 -> 管家记录下次提醒 -> 睡觉”。
V4 需要引入更强的 **"Supervision (监督)"** 机制，专门针对 ADHD 的任务中断问题。

## 🛠️ The Logic: Task Relay (任务接力)

### 1. 触发机制 (Trigger)
- **原有逻辑**: 仅关注 `Start Time` (提醒开始)。
- **新逻辑**: 关注 `End Time + Buffer` (监督结束)。

### 2. 执行流程 (The Workflow)
1.  **Initialize**: 凌晨 02:00 扫描日程时，建立 `SupervisionQueue`。
    - 记录：`Task A` | `End Time: 11:00` | `Check Time: 12:00` (1h Buffer)。
2.  **Monitoring**:
    - 当时间到达 `Check Time` (12:00)。
    - **Check**: 调用 `Google Tasks API` 检查该任务是否已打钩 (Completed)。
3.  **Action**:
    - **IF Completed**: Pass. 记录完成时间，计算下一个任务提醒时间。
    - **IF Pending**: 
        - 检查是否有下一个 `Task B` 正在进行。
        - **IF Idle**: 触发 **"Active Inquiry (主动询问)"**。
        - *Jarvis*: "Don Yotta，检测到上一任务结束已 1 小时且未归档。遇到阻碍了吗？需要拆解任务还是单纯的拖延？"

### 3. 动态更新 (Dynamic Refresh)
- **痛点**: 用户中途修改了 Calendar，导致死队列失效。
- **解法**: 在 `agent.py` 的 `update_event` 工具被调用后，强制触发一次 `plan_morning_routine` (或新的 `refresh_queue` 函数)，重写当天的监督队列。

---
*Status: Pending / Research Mode*
*Priority: High (After Cloud Deployment)*

1. 能级排产协议 (Physiological Anchor Protocol)

目标：将系统从“基于时间触发”升级为“基于能级门控（Gating）”。

逻辑核心：spinal_cord.py 在执行任何非 Tier 0 任务分发前，必须先行轮询 user_state.json。

判定算法 (The 2-Day Rule)：

变量：Energy_History_Array[-2:]

执行策略：

IF all(status == "LOW" for status in Energy_History_Array)：

ACTION：强制拦截所有 Tier 1 及 Tier 2 任务。

REPLY：拒绝对复杂逻辑请求（Reasoning）进行深度处理，输出：“Sir, system detection indicates cumulative fatigue. Cortex logic is restricted to maintenance only.”

低唤醒模式：21:00 后自动调低交互采样率，语气切换为“柔和/劝退”模式。

2. 开发者熔断机制 (Circuit Breaker: Hyperfocus Protection)

目标：通过人工制造“系统不稳定性”来强制中断用户的超焦状态（Hyperfocus）。

监控维度 (Velocity Monitor)：

Input Frequency：Slack 指令输入频率（Tokens per hour）。

Code Velocity：GitHub Commits 频率或代码行数变动（需挂载 Webhook）。

触发逻辑：

当 Velocity > Threshold 持续超过 4 小时时，判定用户处于“自虐式超焦”。

熔断动作 (Artificial Failure)：

模拟故障：系统主动抛出 Pseudo-Error 503 或 System Hibernation Mode。

冷却期：强制锁定本地交互 2 小时，仅保留 Tier 0 紧急通知。

3. 战略留白任务化 (Selective Slack Gating)

目标：重构“休息”在优先级矩阵中的地位。

Tier 0 Definition Update：正式将“无目的休整”（Deep Rest/Browsing）写入 config/settings.py 的 Tier 0 列表。

反焦虑阻断：当用户试图在日历中填满任务时，Jarvis 会强制插入一个 60min 的 NULL_BLOCK，且该 Block 不可被覆盖。